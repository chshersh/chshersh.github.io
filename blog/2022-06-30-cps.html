<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Using a 50-years old technique for solving modern issues</title>
    <meta name="author" content="Dmitrii Kovanikov">
    <meta name="description" content="Utilising the CPS transformation for code maintainability">

    <link rel="stylesheet" href="/css/article.css">

    <!-- Metatags -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Dmitrii Kovanikov aka chshersh" />
    <meta property="og:title" content="Using a 50-years old technique for solving modern issues" />
    <meta property="og:description" content="Dmitrii Kovanikov's Personas Web Space" />
    <meta property="og:url" content="https://chshersh.com" />
    <meta property="og:image" content="https://chshersh.com/images/logo.jpg" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Using a 50-years old technique for solving modern issues" />
    <meta name="twitter:description" content="Utilising the CPS transformation for code maintainability" />
    <meta name="twitter:image" content="https://chshersh.com/images/logo.jpg" />
    <meta name="twitter:image:src" content="https://chshersh.com/images/logo.jpg" />
    <meta name="twitter:url" content="https://chshersh.com" />

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
</head>
<body>
    <div id="imagePopup" class="popup-overlay">
        <img class="popup-image" id="popupImg" src="" alt="">
    </div>

    <header>
      <h1>Using a 50-years old technique for solving modern issues</h1>
    </header>

    <main>
<div class="home-button-container">
  <a href="/index.html" class="home-button"><strong>go ~to:Home</strong></a>
</div>

<p>While implementing Haskell functions with deeply nested logic, I’ve discovered a particular trick that allows writing more modular code by solving annoying indentation errors at the same time.</p>
<p>The described technique uses the CPS transformation and Haskell layout parsing rules. It sounds scary but in its core it’s just a refactoring using Higher-Order Functions, no fancy features involved.</p>
<h2 id="problem">Problem</h2>
<p>To understand the solution, let’s first look at the problem.</p>
<blockquote>
<p>📜 <strong>DISCLAIMER</strong>: I’m using one single example throughout the entire blog post. This example introduces a specific problem and solves it using the described technique. It serves only in educational purposes of showcasing the particular refactoring methods. You could’ve have a similar problem and solved it differently. You could’ve even avoid having this problem at all by designing your software differently. I’m not arguing here that the proposed solution is the best solution. So, please, don’t argue with me by saying I don’t understand what I’m doing because you didn’t have a similar problem.</p>
</blockquote>
<p>Let’s say we’re working on the backend part of a web-application. We want to write a function that associates a user in our system with with their email if the user doesn’t already have an email. To be more specific, this function should do the following:</p>
<ol type="1">
<li>Take a user session token and get the user ID from it.</li>
<li>Check if the given user already has an email.</li>
<li>Check if someone else already associated this email with them.</li>
<li>If all good, associate the user with an email by inserting the data in the database.</li>
</ol>
<p>In a simplified case, let’s say that we already have the following types and functions:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">UserSession</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">UserId</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Email</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">ID</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">InternalDbError</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="ot">validateUserSession ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">UserId</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a><span class="ot">getEmailByUserId ::</span> <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">Email</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="ot">getUserIdByEmail ::</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">UserId</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="ot">insertUserEmail ::</span> <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">InternalDbError</span> <span class="dt">ID</span>)</span></code></pre></div>
<p>And now we want to glue our API functions together into the following function and report all possible error cases as well:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">AppError</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>    <span class="ot">=</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">UserAlreadyHasEmail</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">UserHasDifferentEmail</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">EmailIsTaken</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">DbError</span> <span class="dt">InternalDbError</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="ot">associateEmail ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span></code></pre></div>
<h2 id="baseline">Baseline</h2>
<p>The simplest and straighforward implementation of the desired function would be to use all the API methods directly and pattern-match on their results as we go. This is demonstrated by the following code snippet:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ot">associateEmail ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>    validateUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>        <span class="dt">Just</span> userId <span class="ot">-&gt;</span> getEmailByUserId userId <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>            <span class="dt">Just</span> otherEmail</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>                <span class="op">|</span> email <span class="op">==</span> otherEmail <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserAlreadyHasEmail</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>                <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserHasDifferentEmail</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> getUserIdByEmail email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>                <span class="dt">Just</span> otherUserId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">EmailIsTaken</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> insertUserEmail userId email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>                    <span class="dt">Left</span> dbErr <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">DbError</span> dbErr</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>                    <span class="dt">Right</span> id&#39; <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id&#39;</span></code></pre></div>
<blockquote>
<p>👩‍🔬 The above code snippet uses the <a href="https://downloads.haskell.org/ghc/latest/docs/html/users_guide/exts/lambda_case.html">LambdaCase</a> Haskell feature.</p>
</blockquote>
<p>This simple implementation doesn’t use any advanced features and is easy to read by Haskell beginners. However, it has several problems that we would like to solve:</p>
<ul>
<li><strong>The code is deeply nested.</strong> It slowly turns into a weird staircase as we add more steps.</li>
<li><strong>It mixes business logic with pesky implementation details.</strong> The high-level description of this function has only four clear steps but it’s extremely difficult to extract them quickly from this particular implementation. The problem becomes more severe as you add more steps or start introducing more complicated logic (e.g. logging, monitoring, etc.).</li>
</ul>
<h2 id="either-isation">Either-isation</h2>
<p>A one possible approach to improving the situation would be to introduce a separate function for each individual step. Those functions would return <code>Either AppError smth</code> and will hide the implementation details. The code will look like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="ot">checkUserSession ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">UserId</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>checkUserSession userSession <span class="ot">=</span> validateUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>    <span class="dt">Just</span> userId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> userId</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="ot">checkUserEmail ::</span> <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> ())</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>checkUserEmail userId email <span class="ot">=</span> getEmailByUserId userId <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>    <span class="dt">Just</span> otherEmail</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>        <span class="op">|</span> email <span class="op">==</span> otherEmail <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserAlreadyHasEmail</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>        <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserHasDifferentEmail</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> ()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a><span class="ot">checkOtherUserEmail ::</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> ())</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>checkOtherUserEmail email <span class="ot">=</span> getUserIdByEmail email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>    <span class="dt">Just</span> otherUserId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">EmailIsTaken</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> ()</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a><span class="ot">checkEmailInsert ::</span> <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>checkEmailInsert userId email <span class="ot">=</span> insertUserEmail userId email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>    <span class="dt">Left</span> dbErr <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">DbError</span> dbErr</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>    <span class="dt">Right</span> id&#39;  <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id&#39;</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a>associateEmail</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a>    checkUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a>        <span class="dt">Left</span> err <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> err</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a>        <span class="dt">Right</span> userId <span class="ot">-&gt;</span> checkUserEmail userId email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true"></a>            <span class="dt">Left</span> err <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> err</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true"></a>            <span class="dt">Right</span> () <span class="ot">-&gt;</span> checkOtherUserEmail email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true"></a>                <span class="dt">Left</span> err <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> err</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true"></a>                <span class="dt">Right</span> () <span class="ot">-&gt;</span> checkEmailInsert userId email</span></code></pre></div>
<blockquote>
<p>👩‍🔬 Here we explicitly prefer to return <code>Either AppError ()</code> instead of <code>Maybe AppError</code> or something else for consistency. This will also become handy as we explore other approaches.</p>
</blockquote>
<p>This refactoring is simple and pretty straightforward but it doesn’t solved any of two problems we have above despite writing much more code. Though, the code of <code>associateEmail</code> became slightly more understandable due to uniform handling of errors and we’re now able to add more implementation details to each step without polluting the implementation of <code>associateEmail</code>.</p>
<h2 id="exceptt">ExceptT</h2>
<p>The problem with out-of-control nested indentation annoyed thousands of Haskell developers even before you and me. In this particular case, where all your functions return <code>IO (Either TheSameErrorType anything)</code>, you can use the <a href="https://hackage.haskell.org/package/transformers-0.6.0.4/docs/Control-Monad-Trans-Except.html"><code>ExceptT</code> monad transformer</a>.</p>
<p>I won’t go into much details about <code>ExcepT</code>. This blog post is not a monad transformer tutorial. But I’m going to mention this approach as it’s quite common and still pretty basic in terms of language features.</p>
<p>Once you performed Either-isation of your functions, you can wrap each function into the <code>ExceptT</code> type. This change is quite mechanical in our case:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="st">-checkUserSession :: UserSession -&gt; IO (Either AppError UserId)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="va">+checkUserSession :: UserSession -&gt; ExceptT AppError IO UserId</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="st">-checkUserSession userSession = validateUserSession userSession &gt;&gt;= \case</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="va">+checkUserSession userSession = ExceptT $ validateUserSession userSession &gt;&gt;= \case</span></span></code></pre></div>
<p>After applying this refactoring to each function, we can update the implementation of <code>associateEmail</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>associateEmail</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>associateEmail userSession email <span class="ot">=</span> runExceptT <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>    userId <span class="ot">&lt;-</span> checkUserSession userSession</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>    checkUserEmail userId email</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>    checkOtherUserEmail email</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    checkEmailInsert userId email</span></code></pre></div>
<p>Now we finally solved our both problems! However, at what cost 😢 We’ve introduced a rather complicated concept of monad transformers to the codebase which makes the code less beginner-friendly. On top of that, <code>ExceptT</code> brings different problems such as <a href="https://www.youtube.com/watch?v=KZIN9f9rI34">broken behaviour when used with concurrency</a>.</p>
<h2 id="cps-transformation">CPS transformation</h2>
<p>The <code>ExceptT</code> solution allows us to achieve the desired shape of the <code>associateEmail</code> function but this approach has several drawbacks. Let’s use a different approach — <a href="https://en.wikipedia.org/wiki/Continuation-passing_style">Continuation-Passing Style (CPS)</a> transformation.</p>
<p>The term CPS itself is not modern. It exists since 1975. It’s usually mentioned a lot in compiler development or in relation to <a href="http://callbackhell.com/">callback hell</a>. However, we’re going to put a new perspective on this good old trick.</p>
<p>The main idea behind the CPS transformation is simple: instead of returning a value from a function, we take a callback (also called “continutation”) as an argument and run it on the result instead of returning the result.</p>
<p>For example, here is what we had before:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="ot">checkUserSession ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">UserId</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>checkUserSession userSession <span class="ot">=</span> validateUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>    <span class="dt">Just</span> userId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> userId</span></code></pre></div>
<p>And here is <code>checkUserSession</code> after applying the CPS transformation:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>withUserSession</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>    <span class="ot">-&gt;</span> (<span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>withUserSession userSession next <span class="ot">=</span> validateUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>    <span class="dt">Just</span> userId <span class="ot">-&gt;</span> next userId</span></code></pre></div>
<p>In this transformation, I performed several things:</p>
<ol type="1">
<li>Renamed the function from <code>checkUserSession</code> to <code>withUserSession</code> to convey the intention behind this function: it takes an action to be performed “with user session”.</li>
<li>Added extra argument — continuation — a function of type <code>UserId -&gt; IO (Either AppError a)</code>. So <code>withUserSession</code> is a Higher-Order Function now. ⚠️ <strong>Important</strong>: the return type of our continuation is polymorphic (as well as the return type of our function) to make usage more flexible.</li>
<li>Split type signature into multiple lines as it’s became longer here.</li>
<li>Returned <code>next userId</code> instead of <code>pure $ Right userId</code> in the end.</li>
</ol>
<p>Our transformed <code>withUserSession</code> function now either short-circuits with an error or runs a given continuation with <code>userId</code> in case of success. It takes a continuation and passes the result to it, hence the name — Continuation-Passing Style.</p>
<p>Now, we apply the CPS transformation to every function:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a>withCheckedUserEmail</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">UserId</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>withCheckedUserEmail userId email next <span class="ot">=</span> getEmailByUserId userId <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>    <span class="dt">Just</span> otherEmail</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>        <span class="op">|</span> email <span class="op">==</span> otherEmail <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserAlreadyHasEmail</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a>        <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserHasDifferentEmail</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> next</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a>withCheckedOtherUserEmail</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">Email</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a>withCheckedOtherUserEmail email next <span class="ot">=</span> getUserIdByEmail email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a>    <span class="dt">Just</span> otherUserId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">EmailIsTaken</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> next</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a>withEmailInsert</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">UserId</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true"></a>    <span class="ot">-&gt;</span> (<span class="dt">ID</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a))</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true"></a>withEmailInsert userId email next <span class="ot">=</span> insertUserEmail userId email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true"></a>    <span class="dt">Left</span> dbErr <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">DbError</span> dbErr</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true"></a>    <span class="dt">Right</span> id&#39;  <span class="ot">-&gt;</span> next id&#39;</span></code></pre></div>
<p>A few notes on the implementation:</p>
<ul>
<li>When we don’t have a meaningful argument to pass to continuation (e.g. the function returns a value of the unit type <code>()</code>), we can simply pass an action instead of a function.</li>
<li><code>withEmailInsert</code> will be called last but we still apply the CPS transformation to it. This approach is better for composability in case we want to use this function in the middle of another function and not necessarily in the end.</li>
</ul>
<p>After we’ve performed this refactoring, we can now use our CPS-transformed functions in <code>associateEmail</code>. We’re going to use the chain of nested continuations:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>associateEmail</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>    withUserSession userSession <span class="op">$</span> \userId <span class="ot">-&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>        withCheckedUserEmail userId email <span class="op">$</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>            withCheckedOtherUserEmail email <span class="op">$</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a>                withEmailInsert userId email <span class="op">$</span> \id&#39; <span class="ot">-&gt;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a>                    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id&#39;</span></code></pre></div>
<p>What will happen is that <code>withUserSession</code> will validate user session and call the <code>\userId -&gt; ...</code> lambda if everything is good. The lambda starts with the call to <code>withCheckedUserEmail</code>. This function will then check if the user already has an email and call the next action (starting with <code>withCheckedOtherUserEmail</code>) after the validation passes. And so on.</p>
<p>Wait a minute! You can say that the implementation of <code>associateEmail</code> is still deeply nested and you’ll be absolutely right. We see the four steps clearly but we still have this annoying alignment requirement.</p>
<p>The solution to this problem is simply to not indent the code at all:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>associateEmail</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>    withUserSession userSession <span class="op">$</span> \userId <span class="ot">-&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>    withCheckedUserEmail userId email <span class="op">$</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>    withCheckedOtherUserEmail email <span class="op">$</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>    withEmailInsert userId email <span class="op">$</span> \id&#39; <span class="ot">-&gt;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a>    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id&#39;</span></code></pre></div>
<figure>
<img src="/images/cps/haskell-indent.jpg" alt="" /><figcaption>Haskell indentation: The Neat part</figcaption>
</figure>
<p>This works because Haskell parsing rules around layouts are quite flexible in this case. Semantically, everything “to the right of” lambda belongs to this lambda. So we don’t need this extra indentation here. This doesn’t work for <code>case-of</code> expressions and <code>do</code>-notation blocks but surprisingly works for lambdas and arguments after <code>$</code> outside <code>do</code> blocks.</p>
<p>You can go one step further in making this code look cleaner. I’m <a href="https://osa1.net/posts/2020-01-22-no-small-syntax-extensions.html">not a fan</a> of the <a href="https://downloads.haskell.org/ghc/latest/docs/html/users_guide/exts/block_arguments.html?highlight=blockarguments#extension-BlockArguments">BlockArguments</a> extension in Haskell but if you like it, you can write the final function with slightly less operator noise:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a>associateEmail</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>    withUserSession userSession \userId <span class="ot">-&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>    withCheckedUserEmail userId email <span class="op">$</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>    withCheckedOtherUserEmail email <span class="op">$</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>    withEmailInsert userId email \id&#39; <span class="ot">-&gt;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id&#39;</span></code></pre></div>
<p>You can check the entire code after applying the CPS transformation here:</p>
<ul>
<li><a href="https://gist.github.com/chshersh/e230558a42ee4142fb7303527c08298c">CPS transformation in action</a></li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>In this blog post I’ve described how you can make code cleaner by using the fundamental Haskell feature Higher-Order Functions with combination of 50-years old technique. Sometimes, you don’t need fancy tools to improve your life when fundamentals are solid and already powerful enough.</p>

<hr>
<blockquote>
<p>If you liked this blog post, consider supporting my work on GitHub Sponsors, or following me on the Internet:</p>
<ul>
<li><a target="_blank" href="https://github.com/sponsors/chshersh">GitHub Sponsors: @chshersh</a></li>
<li><a target="_blank" href="https://youtube.com/c/chshersh">YouTube: @chshersh</a></li>
<li><a target="_blank" href="https://x.com/ChShersh">𝕏: @chshersh</a></li>
<li><a target="_blank" href="https://bsky.app/profile/chshersh.com">BlueSky: @chshersh.com</a></li>
<li><a target="_blank" href="https://functional.cafe/@chshersh">Mastodon: functional.cafe@chshersh</a></li>
<li><a target="_blank" href="https://www.twitch.tv/chshersh">Twitch: @chshersh </a></li>
</ul>
</blockquote>
    </main>

<script src="/js/article.js"></script>

</body>
</html>
