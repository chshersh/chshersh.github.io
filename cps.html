<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135017265-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-135017265-1');
    </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Personal website and some blog posts">
  <meta name="author" content="Dmitrii Kovanikov">

  <title>Using a 50-years old technique for solving modern issues</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <!-- Custom fonts for this template -->
  <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

  <!-- Custom styles for this template -->
  <link href="./css/resume.css" rel="stylesheet">
  <link href="./css/dracula.css" rel="stylesheet">
  <link href="./css/post.css" rel="stylesheet">

  <!-- Metatags -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="kodimensional by Dmitrii Kovanikov" />
  <meta property="og:title" content="kodimensional :: Using a 50-years old technique for solving modern issues" />
  <meta property="og:description" content="Utilising the CPS transformation for code maintainability" />
  <meta property="og:url" content="https://kodimensional.dev" />
  <meta property="og:image" content="/images/logo-yellow.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="kodimensional :: Using a 50-years old technique for solving modern issues" />
  <meta name="twitter:description" content="Utilising the CPS transformation for code maintainability" />
  <meta name="twitter:image:src" content="https://kodimensional.dev/images/logo-yellow.png" />
  <meta name="twitter:url" content="https://kodimensional.dev" />

  <!-- Favicon -->
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="./images/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="./images/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="./images/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="./images/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="./images/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="./images/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="./images/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="./images/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./images/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./images/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="./images/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./images/icons/favicon-16x16.png">
  <link rel="manifest" href="./images/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

</head>

<body id="page-top">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary" id="sideNav">
    <h2 class="mb-0 blog-name text-uppercase"><span class="text-white">ko</span>dimensional</h2>
    <p class="text-black d-lg-block d-none">by Dmitrii Kovanikov</p>

    <a class="navbar-brand js-scroll-trigger" href="./">
      <span class="d-block d-lg-none">Dmitrii Kovanikov</span>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="./#about">Œª &rarr; ABOUT</a>
        </li>
        <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="./#experience">Œª &rarr; EXPERIENCE</a>
        </li>
        <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="./#projects">Œª &rarr; PROJECTS</a>
        </li>
        <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="./#blog">Œª &rarr; BLOG</a>
        </li>
      </ul>

    </div>

    <div class="social-icons row justify-content-center">
      <iframe src="https://github.com/sponsors/chshersh/button" title="Sponsor chshersh" height="35" width="50%" style="border: 0;"></iframe>
    </div>

    <div class="social-icons row justify-content-center">
        
        <div class="col-2 col-lg-4 py-1">
          <a href="https://twitter.com/chshersh" target="_blank">
              <i class="fab fa-twitter"></i>
          </a>
        </div>
        
        <div class="col-2 col-lg-4 py-1">
          <a href="https://github.com/chshersh" target="_blank">
              <i class="fab fa-github"></i>
          </a>
        </div>
        
        <div class="col-2 col-lg-4 py-1">
          <a href="https://youtube.com/c/chshersh" target="_blank">
              <i class="fab fa-youtube"></i>
          </a>
        </div>
        
        <div class="col-2 col-lg-4 py-1">
          <a href="https://www.reddit.com/user/chshersh" target="_blank">
              <i class="fab fa-reddit"></i>
          </a>
        </div>
        
        <div class="col-2 col-lg-4 py-1">
          <a href="https://stackoverflow.com/users/2900502/shersh" target="_blank">
              <i class="fab fa-stack-overflow"></i>
          </a>
        </div>
        
        <div class="col-2 col-lg-4 py-1">
          <a href="https://www.linkedin.com/in/chshersh/" target="_blank">
              <i class="fab fa-linkedin"></i>
          </a>
        </div>
        
    </div>

  </nav>

  <div class="container-fluid p-0">

      <section class="resume-section p-3 p-lg-5">
        <h2 class="text-center">Using a 50-years old technique for solving modern issues</h2>
        <p class="text-center text-black"><strong>Created:</strong> June 30, 2022</p>
        

        <div class="col-12 tag-block text-center">
            
            <span class="post-tag"><a class="btn btn-outline-warning">haskell</a></span>
            
            <span class="post-tag"><a class="btn btn-outline-warning">syntax</a></span>
            
            <span class="post-tag"><a class="btn btn-outline-warning">language</a></span>
            
        </div>

        <div class="post toc-header"><ul>
<li><a href="#problem" id="toc-problem">Problem</a></li>
<li><a href="#baseline" id="toc-baseline">Baseline</a></li>
<li><a href="#either-isation" id="toc-either-isation">Either-isation</a></li>
<li><a href="#exceptt" id="toc-exceptt">ExceptT</a></li>
<li><a href="#cps-transformation" id="toc-cps-transformation">CPS transformation</a></li>
<li><a href="#conclusion" id="toc-conclusion">Conclusion</a></li>
</ul></div>
        <div class="post"><p>While implementing Haskell functions with deeply nested logic, I‚Äôve
discovered a particular trick that allows writing more modular code by
solving annoying indentation errors at the same time.</p>
<p>The described technique uses the CPS transformation and Haskell layout
parsing rules. It sounds scary but in its core it‚Äôs just a refactoring
using Higher-Order Functions, no fancy features involved.</p>
<h2 id="problem"><a href="#problem" class="anchor">Problem</a></h2>
<p>To understand the solution, let‚Äôs first look at the problem.</p>
<blockquote>
<p>üìú <strong>DISCLAIMER</strong>: I‚Äôm using one single example throughout the
entire blog post. This example introduces a specific problem and
solves it using the described technique. It serves only in
educational purposes of showcasing the particular refactoring
methods. You could‚Äôve have a similar problem and solved it
differently. You could‚Äôve even avoid having this problem at all by
designing your software differently. I‚Äôm not arguing here that the
proposed solution is the best solution. So, please, don‚Äôt argue with
me by saying I don‚Äôt understand what I‚Äôm doing because you didn‚Äôt
have a similar problem.</p>
</blockquote>
<p>Let‚Äôs say we‚Äôre working on the backend part of a web-application. We
want to write a function that associates a user in our system with
with their email if the user doesn‚Äôt already have an email. To be more
specific, this function should do the following:</p>
<ol type="1">
<li>Take a user session token and get the user ID from it.</li>
<li>Check if the given user already has an email.</li>
<li>Check if someone else already associated this email with them.</li>
<li>If all good, associate the user with an email by inserting the data
in the database.</li>
</ol>
<p>In a simplified case, let‚Äôs say that we already have the following
types and functions:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">UserSession</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">UserId</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Email</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">ID</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">InternalDbError</span> <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ot">validateUserSession ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">UserId</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="ot">getEmailByUserId ::</span> <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">Email</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="ot">getUserIdByEmail ::</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">UserId</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="ot">insertUserEmail ::</span> <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">InternalDbError</span> <span class="dt">ID</span>)</span></code></pre></div>
<p>And now we want to glue our API functions together into the following
function and report all possible error cases as well:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">AppError</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">UserAlreadyHasEmail</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">UserHasDifferentEmail</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">EmailIsTaken</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">DbError</span> <span class="dt">InternalDbError</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="ot">associateEmail ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span></code></pre></div>
<h2 id="baseline"><a href="#baseline" class="anchor">Baseline</a></h2>
<p>The simplest and straighforward implementation of the desired function
would be to use all the API methods directly and pattern-match on
their results as we go. This is demonstrated by the following code
snippet:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">associateEmail ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    validateUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> userId <span class="ot">-&gt;</span> getEmailByUserId userId <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Just</span> otherEmail</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> email <span class="op">==</span> otherEmail <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserAlreadyHasEmail</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserHasDifferentEmail</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> getUserIdByEmail email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Just</span> otherUserId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">EmailIsTaken</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> insertUserEmail userId email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Left</span> dbErr <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">DbError</span> dbErr</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Right</span> id' <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id'</span></code></pre></div>
<blockquote>
<p>üë©‚Äçüî¨ The above code snippet uses the
<a href="https://downloads.haskell.org/ghc/latest/docs/html/users_guide/exts/lambda_case.html">LambdaCase</a>
Haskell feature.</p>
</blockquote>
<p>This simple implementation doesn‚Äôt use any advanced features and is
easy to read by Haskell beginners. However, it has several problems
that we would like to solve:</p>
<ul>
<li><strong>The code is deeply nested.</strong> It slowly turns into a weird
staircase as we add more steps.</li>
<li><strong>It mixes business logic with pesky implementation details.</strong> The
high-level description of this function has only four clear steps
but it‚Äôs extremely difficult to extract them quickly from this
particular implementation. The problem becomes more severe as you
add more steps or start introducing more complicated logic
(e.g.¬†logging, monitoring, etc.).</li>
</ul>
<h2 id="either-isation"><a href="#either-isation" class="anchor">Either-isation</a></h2>
<p>A one possible approach to improving the situation would be to
introduce a separate function for each individual step. Those
functions would return <code>Either AppError smth</code> and will hide the
implementation details. The code will look like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">checkUserSession ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">UserId</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>checkUserSession userSession <span class="ot">=</span> validateUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> userId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> userId</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ot">checkUserEmail ::</span> <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> ())</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>checkUserEmail userId email <span class="ot">=</span> getEmailByUserId userId <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> otherEmail</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> email <span class="op">==</span> otherEmail <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserAlreadyHasEmail</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserHasDifferentEmail</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> ()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="ot">checkOtherUserEmail ::</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> ())</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>checkOtherUserEmail email <span class="ot">=</span> getUserIdByEmail email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> otherUserId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">EmailIsTaken</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> ()</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="ot">checkEmailInsert ::</span> <span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">Email</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>checkEmailInsert userId email <span class="ot">=</span> insertUserEmail userId email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Left</span> dbErr <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">DbError</span> dbErr</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> id'  <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id'</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>associateEmail</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    checkUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Left</span> err <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> err</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Right</span> userId <span class="ot">-&gt;</span> checkUserEmail userId email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Left</span> err <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> err</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Right</span> () <span class="ot">-&gt;</span> checkOtherUserEmail email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Left</span> err <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> err</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Right</span> () <span class="ot">-&gt;</span> checkEmailInsert userId email</span></code></pre></div>
<blockquote>
<p>üë©‚Äçüî¨ Here we explicitly prefer to return <code>Either AppError ()</code>
instead of <code>Maybe AppError</code> or something else for consistency. This
will also become handy as we explore other approaches.</p>
</blockquote>
<p>This refactoring is simple and pretty straightforward but it doesn‚Äôt
solved any of two problems we have above despite writing much more
code. Though, the code of <code>associateEmail</code> became slightly more
understandable due to uniform handling of errors and we‚Äôre now able to
add more implementation details to each step without polluting the
implementation of <code>associateEmail</code>.</p>
<h2 id="exceptt"><a href="#exceptt" class="anchor">ExceptT</a></h2>
<p>The problem with out-of-control nested indentation annoyed thousands
of Haskell developers even before you and me. In this particular case,
where all your functions return <code>IO (Either TheSameErrorType anything)</code>, you can use the
<a href="https://hackage.haskell.org/package/transformers-0.6.0.4/docs/Control-Monad-Trans-Except.html"><code>ExceptT</code> monad transformer</a>.</p>
<p>I won‚Äôt go into much details about <code>ExcepT</code>. This blog post is not a
monad transformer tutorial. But I‚Äôm going to mention this approach as
it‚Äôs quite common and still pretty basic in terms of language
features.</p>
<p>Once you performed Either-isation of your functions, you can wrap each
function into the <code>ExceptT</code> type. This change is quite mechanical in
our case:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="st">-checkUserSession :: UserSession -&gt; IO (Either AppError UserId)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="va">+checkUserSession :: UserSession -&gt; ExceptT AppError IO UserId</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="st">-checkUserSession userSession = validateUserSession userSession &gt;&gt;= \case</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="va">+checkUserSession userSession = ExceptT $ validateUserSession userSession &gt;&gt;= \case</span></span></code></pre></div>
<p>After applying this refactoring to each function, we can update the
implementation of <code>associateEmail</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>associateEmail</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>associateEmail userSession email <span class="ot">=</span> runExceptT <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    userId <span class="ot">&lt;-</span> checkUserSession userSession</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    checkUserEmail userId email</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    checkOtherUserEmail email</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    checkEmailInsert userId email</span></code></pre></div>
<p>Now we finally solved our both problems! However, at what cost üò¢
We‚Äôve introduced a rather complicated concept of monad transformers to
the codebase which makes the code less beginner-friendly. On top of
that, <code>ExceptT</code> brings different problems such as
<a href="https://www.youtube.com/watch?v=KZIN9f9rI34">broken behaviour when used with concurrency</a>.</p>
<h2 id="cps-transformation"><a href="#cps-transformation" class="anchor">CPS transformation</a></h2>
<p>The <code>ExceptT</code> solution allows us to achieve the desired shape of the
<code>associateEmail</code> function but this approach has several
drawbacks. Let‚Äôs use a different approach ‚Äî
<a href="https://en.wikipedia.org/wiki/Continuation-passing_style">Continuation-Passing Style (CPS)</a>
transformation.</p>
<p>The term CPS itself is not modern. It exists since 1975. It‚Äôs usually
mentioned a lot in compiler development or in relation to
<a href="http://callbackhell.com/">callback hell</a>. However, we‚Äôre going to put
a new perspective on this good old trick.</p>
<p>The main idea behind the CPS transformation is simple: instead of
returning a value from a function, we take a callback (also called
‚Äúcontinutation‚Äù) as an argument and run it on the result instead of
returning the result.</p>
<p>For example, here is what we had before:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">checkUserSession ::</span> <span class="dt">UserSession</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">UserId</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>checkUserSession userSession <span class="ot">=</span> validateUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> userId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> userId</span></code></pre></div>
<p>And here is <code>checkUserSession</code> after applying the CPS transformation:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>withUserSession</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> (<span class="dt">UserId</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>withUserSession userSession next <span class="ot">=</span> validateUserSession userSession <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserSessionIsInvalid</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> userId <span class="ot">-&gt;</span> next userId</span></code></pre></div>
<p>In this transformation, I performed several things:</p>
<ol type="1">
<li>Renamed the function from <code>checkUserSession</code> to <code>withUserSession</code>
to convey the intention behind this function: it takes an action to
be performed ‚Äúwith user session‚Äù.</li>
<li>Added extra argument ‚Äî continuation ‚Äî a function of type
<code>UserId -&gt; IO (Either AppError a)</code>. So <code>withUserSession</code> is a
Higher-Order Function now. ‚ö†Ô∏è <strong>Important</strong>: the return type of our
continuation is polymorphic (as well as the return type of our
function) to make usage more flexible.</li>
<li>Split type signature into multiple lines as it‚Äôs became longer here.</li>
<li>Returned <code>next userId</code> instead of <code>pure $ Right userId</code> in the end.</li>
</ol>
<p>Our transformed <code>withUserSession</code> function now either short-circuits
with an error or runs a given continuation with <code>userId</code> in case of
success. It takes a continuation and passes the result to it, hence
the name ‚Äî Continuation-Passing Style.</p>
<p>Now, we apply the CPS transformation to every function:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>withCheckedUserEmail</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">UserId</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>withCheckedUserEmail userId email next <span class="ot">=</span> getEmailByUserId userId <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> otherEmail</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> email <span class="op">==</span> otherEmail <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserAlreadyHasEmail</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">UserHasDifferentEmail</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> next</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>withCheckedOtherUserEmail</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">Email</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>withCheckedOtherUserEmail email next <span class="ot">=</span> getUserIdByEmail email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> otherUserId <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="dt">EmailIsTaken</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> next</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>withEmailInsert</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">UserId</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> (<span class="dt">ID</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a))</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> a)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>withEmailInsert userId email next <span class="ot">=</span> insertUserEmail userId email <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Left</span> dbErr <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">DbError</span> dbErr</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> id'  <span class="ot">-&gt;</span> next id'</span></code></pre></div>
<p>A few notes on the implementation:</p>
<ul>
<li>When we don‚Äôt have a meaningful argument to pass to continuation
(e.g.¬†the function returns a value of the unit type <code>()</code>), we can
simply pass an action instead of a function.</li>
<li><code>withEmailInsert</code> will be called last but we still apply the CPS
transformation to it. This approach is better for composability in
case we want to use this function in the middle of another function
and not necessarily in the end.</li>
</ul>
<p>After we‚Äôve performed this refactoring, we can now use our
CPS-transformed functions in <code>associateEmail</code>. We‚Äôre going to use the
chain of nested continuations:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>associateEmail</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    withUserSession userSession <span class="op">$</span> \userId <span class="ot">-&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        withCheckedUserEmail userId email <span class="op">$</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            withCheckedOtherUserEmail email <span class="op">$</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                withEmailInsert userId email <span class="op">$</span> \id' <span class="ot">-&gt;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id'</span></code></pre></div>
<p>What will happen is that <code>withUserSession</code> will validate user session
and call the <code>\userId -&gt; ...</code> lambda if everything is good. The lambda
starts with the call to <code>withCheckedUserEmail</code>. This function will
then check if the user already has an email and call the next action
(starting with <code>withCheckedOtherUserEmail</code>) after the validation
passes. And so on.</p>
<p>Wait a minute! You can say that the implementation of <code>associateEmail</code>
is still deeply nested and you‚Äôll be absolutely right. We see the four
steps clearly but we still have this annoying alignment requirement.</p>
<p>The solution to this problem is simply to not indent the code at all:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>associateEmail</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    withUserSession userSession <span class="op">$</span> \userId <span class="ot">-&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    withCheckedUserEmail userId email <span class="op">$</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    withCheckedOtherUserEmail email <span class="op">$</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    withEmailInsert userId email <span class="op">$</span> \id' <span class="ot">-&gt;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id'</span></code></pre></div>
<figure>
<img src="./images/cps/haskell-indent.jpg" alt="Haskell indentation: The Neat part" />
<figcaption aria-hidden="true">Haskell indentation: The Neat part</figcaption>
</figure>
<p>This works because Haskell parsing rules around layouts are quite
flexible in this case. Semantically, everything ‚Äúto the right of‚Äù
lambda belongs to this lambda. So we don‚Äôt need this extra indentation
here. This doesn‚Äôt work for <code>case-of</code> expressions and <code>do</code>-notation
blocks but surprisingly works for lambdas and arguments after <code>$</code>
outside <code>do</code> blocks.</p>
<p>You can go one step further in making this code look cleaner.
I‚Äôm <a href="https://osa1.net/posts/2020-01-22-no-small-syntax-extensions.html">not a fan</a>
of the
<a href="https://downloads.haskell.org/ghc/latest/docs/html/users_guide/exts/block_arguments.html?highlight=blockarguments#extension-BlockArguments">BlockArguments</a>
extension in Haskell but if you like it, you can write the final
function with slightly less operator noise:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>associateEmail</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ::</span> <span class="dt">UserSession</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">Email</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">AppError</span> <span class="dt">ID</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>associateEmail userSession email <span class="ot">=</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    withUserSession userSession \userId <span class="ot">-&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    withCheckedUserEmail userId email <span class="op">$</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    withCheckedOtherUserEmail email <span class="op">$</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    withEmailInsert userId email \id' <span class="ot">-&gt;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Right</span> id'</span></code></pre></div>
<p>You can check the entire code after applying the CPS transformation here:</p>
<ul>
<li><a href="https://gist.github.com/chshersh/e230558a42ee4142fb7303527c08298c">CPS transformation in action</a></li>
</ul>
<h2 id="conclusion"><a href="#conclusion" class="anchor">Conclusion</a></h2>
<p>In this blog post I‚Äôve described how you can make code cleaner by
using the fundamental Haskell feature Higher-Order Functions with
combination of 50-years old technique. Sometimes, you don‚Äôt need fancy
tools to improve your life when fundamentals are solid and already
powerful enough.</p></div>
    </section>

  </div>

  <!-- Bootstrap core JavaScript -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"> </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.0/js/bootstrap.bundle.min.js" integrity="sha384-VoPFvGr9GxhDT3n8vqqZ46twP5lgex+raTCfICQy73NLhN7ZqSfCtfSn4mLA2EFA" crossorigin="anonymous"></script>
  <!-- Plugin JavaScript -->

  <script src="./js/jquery.easing.min.js"></script>
  <!-- Code highlighting  -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
  <script>hljs.initHighlightingOnLoad()</script>

  <!-- Custom scripts for this template -->
  <script src="./js/resume.min.js"></script>

</body>

</html>
